<!DOCTYPE html>
<html lang="sk">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>GlycoStack AI Pro</title>
    <style>
      body {
        background: #121212;
        color: white;
        font-family: sans-serif;
        text-align: center;
        margin: 0;
      }
      #camera-container {
        position: relative;
        width: 100vw;
        height: 60vh;
        background: #000;
      }
      video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .guide-box {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 3px solid #00e676;
        width: 250px;
        height: 250px;
        border-radius: 20px;
        pointer-events: none;
      }
      .controls {
        padding: 15px;
        background: #1a1a1a;
      }
      .btn-capture {
        width: 70px;
        height: 70px;
        background: white;
        border-radius: 50%;
        border: 5px solid #00e676;
      }
      #status-light {
        display: inline-block;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background: grey;
        margin-right: 5px;
      }
      .result-panel {
        background: #000;
        padding: 10px;
        border-top: 2px solid #00e676;
        font-size: 1.1rem;
      }
      input {
        background: #333;
        color: #00e676;
        border: 1px solid #555;
        padding: 5px;
        width: 60px;
        font-size: 1rem;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="camera-container">
      <video id="webcam" autoplay playsinline></video>
      <div class="guide-box"></div>
    </div>
    <div class="result-panel">
      <span id="status-light"></span>
      <span id="precision-text">캛ak치m na foto...</span><br />
      V치ha: <input type="number" id="weight-input" value="0" /> g |
      <b>Sacharidy: <span id="carb-result">0</span>g</b>
    </div>
    <div class="controls">
      <div id="instruction" style="color: #00e676; margin-bottom: 10px">
        KROK 1: Odfo콘 ZHORA
      </div>
      <button class="btn-capture" onclick="takeAction()"></button>
      <button
        onclick="startVoice()"
        style="
          margin-left: 10px;
          background: none;
          border: none;
          font-size: 2rem;
        "
      >
        游꿗
      </button>
    </div>

    <script>
      const video = document.getElementById('webcam');
      const instruction = document.getElementById('instruction');
      const carbResult = document.getElementById('carb-result');
      const weightInput = document.getElementById('weight-input');
      const statusLight = document.getElementById('status-light');
      const precisionText = document.getElementById('precision-text');
      let photos = [];
      let state = 'top';
      const API_KEY = 'AIzaSyCfRBV_Jl_u5bJXlJhfcH3QQ_qSorr_Ue4';

      async function init() {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
        });
        video.srcObject = stream;
      }

      function takeAction() {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        photos.push(canvas.toDataURL('image/jpeg').split(',')[1]);

        if (state === 'top') {
          state = 'side';
          instruction.innerText = 'KROK 2: Odfo콘 ZBOKU (alebo 캜iarov칳 k칩d)';
        } else {
          instruction.innerText = 'AI analyzuje (Google Sken)...';
          analyze();
        }
      }

      async function analyze() {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
        const prompt = `Ak je na fotke 캜iarov칳 k칩d, vr치콘 nutri캜n칠 hodnoty na 100g. Ak je tam jedlo, odhadni gram치 a sacharidy. Form치t: {"vaha": 200, "sacharidy_na_100g": 15, "typ": "vizual/sken"}`;

        const response = await fetch(url, {
          method: 'POST',
          body: JSON.stringify({
            contents: [
              {
                parts: [
                  { text: prompt },
                  { inline_data: { mime_type: 'image/jpeg', data: photos[0] } },
                  { inline_data: { mime_type: 'image/jpeg', data: photos[1] } },
                ],
              },
            ],
          }),
        });
        const res = await response.json();
        const text = res.candidates[0].content.parts[0].text;
        const data = JSON.parse(text.match(/\{.*\}/)[0]);

        weightInput.value = data.vaha;
        updateResult(data.sacharidy_na_100g, data.typ);
      }

      function updateResult(sach100, typ) {
        const total = (weightInput.value / 100) * sach100;
        carbResult.innerText = Math.round(total);
        if (typ === 'sken') {
          statusLight.style.background = 'green';
          precisionText.innerText = 'Vysok치 (Google Sken)';
        } else {
          statusLight.style.background = 'orange';
          precisionText.innerText = 'Stredn치 (Odhad)';
        }
      }

      function startVoice() {
        const recognition = new (window.SpeechRecognition ||
          window.webkitSpeechRecognition)();
        recognition.lang = 'sk-SK';
        recognition.onresult = (e) => {
          const val = e.results[0][0].transcript;
          const num = val.match(/\d+/);
          if (num) {
            weightInput.value = num[0];
            updateResult(15, 'manual');
          }
        };
        recognition.start();
      }

      window.onload = init;
    </script>
  </body>
</html>
